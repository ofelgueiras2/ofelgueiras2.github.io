name: Teste Diagn√≥stico Renv

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  test-renv-cache:
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Configurar reposit√≥rio
        uses: actions/checkout@v4

      # Mostra informa√ß√µes do sistema antes de qualquer outra coisa
      - name: üõ†Ô∏è Diagn√≥stico Inicial
        run: |
          echo "=== Informa√ß√µes do Sistema ==="
          uname -a
          echo "=== Vers√£o do R ==="
          R --version
          echo "=== Caminho do R ==="
          which R
          echo "=== Caminho do Rscript ==="
          which Rscript

      # Instala depend√™ncias do sistema (se necess√°rio)
      - name: üîß Instalar pacotes de sistema necess√°rios
        run: |
          sudo apt update
          sudo apt install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      # Instala o `renv`
      - name: üì¶ Instalar `renv`
        run: |
          Rscript -e 'install.packages("renv", repos="https://cran.rstudio.com/")'

      # Diagn√≥stico: Verificar onde o `renv` est√° a armazenar a cache
      - name: üîç Verificar Caminhos do `renv`
        run: |
          echo "=== Verificando Caminhos do renv ==="
          Rscript -e 'print(Sys.getenv("RENV_PATHS_CACHE"))'
          Rscript -e 'print(renv::paths$cache())'
          Rscript -e 'print(renv::paths$library())'

      # Garante que `renv` est√° inicializado corretamente
      - name: üöÄ Iniciar `renv`
        run: |
          Rscript -e 'if (!renv::status()$synchronized) renv::restore(rebuild = TRUE, prompt = FALSE)'

      # Diagn√≥stico: Verificar pacotes antes do restore
      - name: üîç Verificar Pacotes Antes do Restore
        run: |
          echo "=== Caminhos de bibliotecas antes do renv ==="
          Rscript -e 'print(.libPaths())'
          echo "=== Pacotes instalados antes do restore ==="
          Rscript -e 'print(installed.packages()[,1])'

      # Restaurar pacotes do `renv`
      - name: üîÑ Restaurar Pacotes do `renv`
        run: |
          Rscript -e 'renv::restore(rebuild = TRUE, prompt = FALSE)'

      # Diagn√≥stico: Verificar pacotes depois do restore
      - name: üîç Verificar Pacotes Ap√≥s Restore
        run: |
          echo "=== Caminhos de bibliotecas ap√≥s ativa√ß√£o do renv ==="
          Rscript -e 'print(.libPaths())'
          echo "=== Pacotes instalados ap√≥s restore ==="
          Rscript -e 'print(installed.packages()[,1])'

      # Diagn√≥stico: Listar conte√∫do da cache do `renv`
      - name: üìÇ Verificar Cache do `renv`
        run: |
          echo "=== Conte√∫do da cache renv ==="
          ls -la ~/.cache/R/renv || echo "Cache n√£o encontrada"
          echo "=== Conte√∫do da biblioteca renv ==="
          ls -la renv/library || echo "Biblioteca renv n√£o encontrada"

      # Teste: Verifica se um pacote essencial (`httr`) pode ser carregado
      - name: üß™ Testar carregamento de pacotes
        run: |
          Rscript -e 'library(httr)'
          Rscript -e 'library(dplyr)'
          Rscript -e 'library(lubridate)'

      # Finaliza o workflow e imprime mensagem de sucesso
      - name: ‚úÖ Diagn√≥stico Conclu√≠do
        run: echo "Se chegou at√© aqui sem erros, a configura√ß√£o do `renv` est√° correta!"

