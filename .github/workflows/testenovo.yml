name: Teste DiagnÃ³stico Renv

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  test-renv-cache:
    runs-on: ubuntu-latest

    steps:
      - name: âš™ï¸ Configurar repositÃ³rio
        uses: actions/checkout@v4

      # ğŸ”´ INSTALAR R (A correÃ§Ã£o essencial)
      - name: ğŸ“¦ Instalar R e dependÃªncias
        run: |
          sudo apt update
          sudo apt install -y r-base r-base-dev libcurl4-openssl-dev libssl-dev libxml2-dev

      # Testa se o R foi instalado corretamente
      - name: ğŸ› ï¸ DiagnÃ³stico Inicial
        run: |
          echo "=== InformaÃ§Ãµes do Sistema ==="
          uname -a
          echo "=== VersÃ£o do R ==="
          R --version
          echo "=== Caminho do R ==="
          which R
          echo "=== Caminho do Rscript ==="
          which Rscript

      # Instala o `renv`
      - name: ğŸ“¦ Instalar `renv`
        run: |
          Rscript -e 'install.packages("renv", repos="https://cran.rstudio.com/")'

      # DiagnÃ³stico: Verificar onde o `renv` estÃ¡ a armazenar a cache
      - name: ğŸ” Verificar Caminhos do `renv`
        run: |
          echo "=== Verificando Caminhos do renv ==="
          Rscript -e 'print(Sys.getenv("RENV_PATHS_CACHE"))'
          Rscript -e 'print(renv::paths$cache())'
          Rscript -e 'print(renv::paths$library())'

      # Garante que `renv` estÃ¡ inicializado corretamente
      - name: ğŸš€ Iniciar `renv`
        run: |
          Rscript -e 'if (!renv::status()$synchronized) renv::restore(rebuild = TRUE, prompt = FALSE)'

      # DiagnÃ³stico: Verificar pacotes antes do restore
      - name: ğŸ” Verificar Pacotes Antes do Restore
        run: |
          echo "=== Caminhos de bibliotecas antes do renv ==="
          Rscript -e 'print(.libPaths())'
          echo "=== Pacotes instalados antes do restore ==="
          Rscript -e 'print(installed.packages()[,1])'

      # Restaurar pacotes do `renv`
      - name: ğŸ”„ Restaurar Pacotes do `renv`
        run: |
          Rscript -e 'renv::restore(rebuild = TRUE, prompt = FALSE)'

      # DiagnÃ³stico: Verificar pacotes depois do restore
      - name: ğŸ” Verificar Pacotes ApÃ³s Restore
        run: |
          echo "=== Caminhos de bibliotecas apÃ³s ativaÃ§Ã£o do renv ==="
          Rscript -e 'print(.libPaths())'
          echo "=== Pacotes instalados apÃ³s restore ==="
          Rscript -e 'print(installed.packages()[,1])'

      # DiagnÃ³stico: Listar conteÃºdo da cache do `renv`
      - name: ğŸ“‚ Verificar Cache do `renv`
        run: |
          echo "=== ConteÃºdo da cache renv ==="
          ls -la ~/.cache/R/renv || echo "Cache nÃ£o encontrada"
          echo "=== ConteÃºdo da biblioteca renv ==="
          ls -la renv/library || echo "Biblioteca renv nÃ£o encontrada"

      # Teste: Verifica se um pacote essencial (`httr`) pode ser carregado
      - name: ğŸ§ª Testar carregamento de pacotes
        run: |
          Rscript -e 'library(httr)'
          Rscript -e 'library(dplyr)'
          Rscript -e 'library(lubridate)'

      # Finaliza o workflow e imprime mensagem de sucesso
      - name: âœ… DiagnÃ³stico ConcluÃ­do
        run: echo "Se chegou atÃ© aqui sem erros, a configuraÃ§Ã£o do `renv` estÃ¡ correta!"
