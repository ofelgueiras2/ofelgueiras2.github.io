name: Test renv Cache

on:
  workflow_dispatch:  # Permite execução manual para testar

jobs:
  test-cache:
    runs-on: ubuntu-latest
    env:
      RENV_PATHS_CACHE: ~/.cache/R/renv  # Configura o caminho correto do cache
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup R environment
        uses: r-lib/actions/setup-r@v2

      - name: Setup cache for R packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/R/renv
          key: renv-cache-${{ runner.os }}-${{ hashFiles('renv.lock') }}
          restore-keys: |
            renv-cache-${{ runner.os }}-

      - name: Install renv and restore packages
        run: |
          Rscript -e 'install.packages("renv", repos="https://cran.rstudio.com/")'
          Rscript -e 'renv::restore(prompt = FALSE)'

      - name: Debug renv cache path
        run: |
          echo "### Caminho real do cache do renv:"
          Rscript -e 'print(renv::paths$cache())'

      - name: Install small package (`cli`)
        run: |
          Rscript -e 'renv::activate()'
          Rscript -e 'renv::install("cli")'

      - name: Verify installation
        run: |
          Rscript -e 'library(cli); print("cli package loaded successfully!")'
          echo "### Lista de pacotes instalados no renv:"
          Rscript -e 'print(installed.packages()[,1])'

      - name: Check if package exists in cache
        run: |
          echo "### Verificando cache do renv para o package cli:"
          find ~/.cache/R/renv -name "cli"

