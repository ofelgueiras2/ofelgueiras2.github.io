name: RSelenium Firefox Headless (rsDriver)

on:
  workflow_dispatch:

jobs:
  selenium-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositório
        uses: actions/checkout@v3

      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb openjdk-11-jre-headless libcurl4-openssl-dev libssl-dev libxml2-dev wget libdbus-glib-1-2

      - name: Instalar Firefox 118.0
        run: |
          wget https://ftp.mozilla.org/pub/firefox/releases/118.0/linux-x86_64/en-US/firefox-118.0.tar.bz2
          sudo tar xjf firefox-118.0.tar.bz2 -C /opt
          sudo ln -sf /opt/firefox/firefox /usr/bin/firefox
          firefox --version

      - name: Instalar Geckodriver v0.36.0
        run: |
          wget https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz
          sudo tar xzf geckodriver-v0.36.0-linux64.tar.gz -C /usr/local/bin
          sudo chmod +x /usr/local/bin/geckodriver
          geckodriver --version

      - name: Iniciar Xvfb
        run: |
          sudo pkill Xvfb || true
          sudo rm -rf /tmp/.X99-lock /tmp/.X11-unix/X99
          Xvfb :99 -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 3

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.3'

      - name: Instalar RSelenium
        run: |
          Rscript -e 'install.packages("RSelenium", repos = "https://cloud.r-project.org")'

      - name: Executar teste com rsDriver
        env:
          DISPLAY: :99
        run: |
          Rscript -e '
            library(RSelenium)
            rD <- rsDriver(
              browser = "firefox",
              port = 4545L,
              verbose = TRUE,
              geckover = "0.36.0",
              extraCapabilities = list("moz:firefoxOptions" = list(args = list("--headless")))
            )

            remDr <- rD$client
            remDr$navigate("https://www.google.com")
            Sys.sleep(5)
            current_url <- remDr$getCurrentUrl()[[1]]
            page_title <- remDr$getTitle()[[1]]
            cat("URL atual:", current_url, "\n")
            cat("Título:", page_title, "\n")

            remDr$close()
            rD$server$stop()
          '
