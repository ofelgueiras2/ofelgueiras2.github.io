name: Selenium Test with R

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar dependÃªncias essenciais
        run: |
          sudo snap remove firefox || echo "Firefox snap nÃ£o estava instalado."
          sudo apt update
          sudo apt install -y dbus-x11 xvfb openjdk-17-jre libnss3 wget unzip libcurl4-openssl-dev
          java -version  # Debug Java

      - name: Instalar Firefox sem Snap
        run: |
          sudo add-apt-repository -y ppa:mozillateam/ppa
          sudo apt update
          sudo apt install -y firefox
          firefox --version  # Debug Firefox

      - name: Instalar Geckodriver
        run: |
          GECKO_VERSION="0.36.0"
          wget "https://github.com/mozilla/geckodriver/releases/download/v$GECKO_VERSION/geckodriver-v$GECKO_VERSION-linux64.tar.gz"
          tar -xzf geckodriver-v$GECKO_VERSION-linux64.tar.gz
          sudo mv geckodriver /usr/local/bin/
          rm geckodriver-v$GECKO_VERSION-linux64.tar.gz
          geckodriver --version  # Debug Geckodriver

      - name: Iniciar Xvfb
        run: Xvfb :99 -screen 0 1920x1080x24 &

      - name: Iniciar Selenium Server
        run: |
          export DISPLAY=:99
          wget -q "https://github.com/SeleniumHQ/selenium/releases/download/selenium-4.29.0/selenium-server-4.29.0.jar" -O selenium-server.jar
          nohup java -jar selenium-server.jar standalone --port 4444 --host 127.0.0.1 > selenium.log 2>&1 &
          sleep 10
          echo "ğŸš€ Selenium Server iniciado!"

      - name: Verificar se Selenium estÃ¡ ativo
        run: |
          ps aux | grep "[s]elenium" || (echo "âŒ ERRO: Selenium nÃ£o estÃ¡ rodando!" && cat selenium.log && exit 1)

      - name: Verificar portas ativas
        run: |
          netstat -tuln | grep 4444 || (echo "âŒ ERRO: A porta 4444 nÃ£o estÃ¡ ativa!" && cat selenium.log && exit 1)
